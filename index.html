<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>#juegoFounderZ ‚Äî Antioquia Edition (Plant Nanny x Plant Money)</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Clean modern font (no pixel) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0b0b0f;
      --paper:#fbfbff;
      --acid:#7c3aed;
      --mint:#22c55e;
      --sun:#f59e0b;
      --sky:#38bdf8;
      --rose:#fb7185;
    }

    body { font-family: "Space Grotesk", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    /* Soft brutalism: hard borders, playful layers */
    .brut-card{
      background: rgba(251,251,255,.94);
      border: 3px solid var(--ink);
      box-shadow: 10px 10px 0 rgba(11,11,15,.18);
      border-radius: 18px;
    }
    .brut-chip{
      border: 2px solid var(--ink);
      box-shadow: 4px 4px 0 rgba(11,11,15,.14);
      border-radius: 999px;
      background: rgba(255,255,255,.92);
    }
    .brut-btn{
      border: 3px solid var(--ink);
      box-shadow: 6px 6px 0 rgba(11,11,15,.18);
      border-radius: 16px;
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
      background: rgba(255,255,255,.95);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .brut-btn:hover{ transform: translate(-1px,-1px); box-shadow: 7px 7px 0 rgba(11,11,15,.20); filter: saturate(1.05); }
    .brut-btn:active{ transform: translate(2px,2px); box-shadow: 3px 3px 0 rgba(11,11,15,.18); }

    /* Subtle brutal grid background + noise */
    .bg-grid{
      background:
        linear-gradient(to right, rgba(11,11,15,.08) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(11,11,15,.08) 1px, transparent 1px),
        radial-gradient(900px 700px at 20% 10%, rgba(124,58,237,.16), transparent 55%),
        radial-gradient(900px 700px at 90% 40%, rgba(34,197,94,.12), transparent 55%),
        radial-gradient(900px 700px at 60% 90%, rgba(56,189,248,.12), transparent 55%),
        linear-gradient(180deg, #ffffff, #f7f7ff);
      background-size: 22px 22px, 22px 22px, auto, auto, auto, auto;
    }
    .noise:before{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events:none;
      opacity: .09;
      mix-blend-mode: multiply;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='240' height='240' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      background-size: 240px 240px;
    }

    /* Timer bar */
    .timer-rail{
      border: 2px solid var(--ink);
      border-radius: 999px;
      overflow: hidden;
      background: rgba(255,255,255,.9);
      box-shadow: 4px 4px 0 rgba(11,11,15,.14);
    }
    .timer-fill{
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, rgba(124,58,237,.95), rgba(56,189,248,.95), rgba(34,197,94,.95), rgba(245,158,11,.95));
      transition: width .1s linear;
    }

    /* Feedback anim */
    .pulse-ok{ animation: ok .35s ease-out both; }
    .pulse-bad{ animation: bad .35s ease-out both; }
    @keyframes ok{
      0%{ transform: scale(.985); filter: saturate(1); }
      60%{ transform: scale(1.01); filter: saturate(1.15); }
      100%{ transform: scale(1); filter: saturate(1.05); }
    }
    @keyframes bad{
      0%{ transform: translateX(0); }
      25%{ transform: translateX(-6px); }
      50%{ transform: translateX(6px); }
      75%{ transform: translateX(-4px); }
      100%{ transform: translateX(0); }
    }

    /* HUD sticky */
    .hud-sticky{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(8px);
      background: rgba(251,251,255,.78);
      border-bottom: 3px solid var(--ink);
    }

    /* Isometric icon wrapper */
    .isoIcon{
      width: 52px;
      height: 52px;
      display: grid;
      place-items: center;
      border: 2px solid var(--ink);
      border-radius: 14px;
      box-shadow: 5px 5px 0 rgba(11,11,15,.16);
      background: rgba(255,255,255,.92);
    }
    .isoIcon svg{ width: 40px; height: 40px; display:block; }

    /* Prevent any overlay from eating taps */
    .noise:before{ pointer-events: none !important; }
  </style>
</head>

<body class="bg-grid noise text-slate-900">
  <div class="max-w-6xl mx-auto px-4 pb-10">
    <!-- Top Brand -->
    <header class="pt-6 pb-4">
      <div class="brut-card p-4 sm:p-5">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div>
            <div class="text-xs sm:text-sm text-slate-700 font-semibold">#juegoFounderZ</div>
            <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">
              Antioquia Edition <span class="inline-block align-middle">üå±ü™ôüïµÔ∏è</span>
            </h1>
            <p class="text-sm sm:text-base text-slate-700 mt-1">
              Plant Nanny √ó Plant Money, persecuci√≥n tipo ‚ÄúCarmen San Diego‚Äù por municipios de Antioquia.
            </p>
          </div>
          <span class="brut-chip px-3 py-2 text-xs sm:text-sm">
            Brutalismo suave + iconos isom√©tricos (sin layout 3D)
          </span>
        </div>
      </div>
    </header>

    <!-- Screens -->
    <main id="app" class="space-y-4">

      <!-- START SCREEN -->
      <section id="screenStart" class="brut-card p-5 sm:p-7">
        <div class="grid md:grid-cols-2 gap-6 items-center">
          <div>
            <div class="text-xs text-slate-700 font-semibold">CASO INICIAL</div>
            <h2 class="text-2xl sm:text-3xl font-bold mt-2">
              Robo en el <span class="underline decoration-[var(--acid)] decoration-4">Mercado del Viernes</span>
            </h2>
            <p class="text-slate-700 mt-3 leading-relaxed">
              Desaparecieron <span class="font-semibold">PlantMoney tokens</span>, badges de reputaci√≥n y
              <span class="font-semibold">semillas digitales</span> que sostienen el intercambio comunitario.
              El culpable dej√≥ una firma: <span class="font-semibold">‚ÄúEl Ladr√≥n del Sustrato‚Äù</span>.
            </p>

            <div class="mt-4 flex flex-wrap gap-2">
              <span class="brut-chip px-3 py-2 text-xs">üéØ Precisi√≥n</span>
              <span class="brut-chip px-3 py-2 text-xs">‚è±Ô∏è Rapidez (18s)</span>
              <span class="brut-chip px-3 py-2 text-xs">ü™ô Tokens</span>
              <span class="brut-chip px-3 py-2 text-xs">ü§ù Confianza</span>
              <span class="brut-chip px-3 py-2 text-xs">üíß Riego</span>
            </div>

            <div class="mt-6 flex items-center gap-3">
              <button id="btnStart" class="brut-btn px-5 py-3 font-bold">
                Iniciar persecuci√≥n üöÄ
              </button>
              <button id="btnHow" class="brut-btn px-5 py-3 font-bold bg-[rgba(56,189,248,.18)]">
                ¬øC√≥mo se juega? üß†
              </button>
            </div>

            <div id="howPanel" class="hidden mt-4 brut-card p-4">
              <ul class="list-disc pl-5 text-sm text-slate-700 space-y-1">
                <li>Lee 3 pistas, elige el destino correcto (solo Antioquia).</li>
                <li>Tienes <b>18 segundos</b> por decisi√≥n: m√°s r√°pido = m√°s puntos.</li>
                <li>Completa mini-retos de 1 clic para ganar tokens y confianza.</li>
                <li>Riega tu planta cada ronda: racha = bonus.</li>
                <li>Si la confianza llega a 0, el ladr√≥n escapa.</li>
              </ul>
            </div>
          </div>

          <div class="relative">
            <div class="brut-card p-5 sm:p-6">
              <div class="text-xs text-slate-700 font-semibold">TABLERO DEL MERCADO</div>

              <div class="mt-3 grid grid-cols-2 gap-3">
                <div class="brut-card p-4 flex gap-3 items-start">
                  <div class="isoIcon" aria-hidden="true" id="icoTrueque"></div>
                  <div>
                    <div class="font-semibold">Trueque</div>
                    <div class="text-xs text-slate-600 mt-1">Intercambio local</div>
                  </div>
                </div>
                <div class="brut-card p-4 flex gap-3 items-start">
                  <div class="isoIcon" aria-hidden="true" id="icoSemillas"></div>
                  <div>
                    <div class="font-semibold">Semillas</div>
                    <div class="text-xs text-slate-600 mt-1">Reputaci√≥n crece</div>
                  </div>
                </div>
                <div class="brut-card p-4 flex gap-3 items-start">
                  <div class="isoIcon" aria-hidden="true" id="icoRepair"></div>
                  <div>
                    <div class="font-semibold">Repair Caf√©</div>
                    <div class="text-xs text-slate-600 mt-1">Reusar + reparar</div>
                  </div>
                </div>
                <div class="brut-card p-4 flex gap-3 items-start">
                  <div class="isoIcon" aria-hidden="true" id="icoRegistro"></div>
                  <div>
                    <div class="font-semibold">Registro</div>
                    <div class="text-xs text-slate-600 mt-1">Constancia = bonus</div>
                  </div>
                </div>
              </div>

              <div class="mt-4 brut-card p-4">
                <div class="flex items-center justify-between gap-3">
                  <div>
                    <div class="text-xs text-slate-700 font-semibold">OBJETIVO</div>
                    <div class="font-semibold mt-1">Atrapa al ladr√≥n y recupera los tokens.</div>
                  </div>
                  <div class="text-5xl">üïµÔ∏è‚Äç‚ôÄÔ∏è</div>
                </div>
              </div>

              <div class="mt-3 text-xs text-slate-600">
                Tip: si algo falla en iPad, mira el panel DEBUG abajo.
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- GAME SCREEN -->
      <section id="screenGame" class="hidden">
        <!-- HUD -->
        <div class="hud-sticky rounded-2xl mb-4">
          <div class="px-3 sm:px-4 py-3">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
              <div class="flex flex-wrap gap-2 items-center">
                <span class="brut-chip px-3 py-2 text-xs sm:text-sm">
                  <b>PUNTOS</b> <span id="hudScore" class="font-bold">0</span>
                </span>
                <span class="brut-chip px-3 py-2 text-xs sm:text-sm">
                  <b>TOKENS</b> <span id="hudTokens" class="font-bold">0</span> ü™ô
                </span>
                <span class="brut-chip px-3 py-2 text-xs sm:text-sm">
                  <b>RONDA</b> <span id="hudRound" class="font-bold">1</span>/<span id="hudRoundsTotal" class="font-bold">6</span>
                </span>
                <span class="brut-chip px-3 py-2 text-xs sm:text-sm">
                  <b>MUNICIPIO</b> <span id="hudPlace" class="font-bold">‚Äî</span>
                </span>
              </div>

              <div class="flex flex-wrap gap-2 items-center justify-start lg:justify-end">
                <span class="brut-chip px-3 py-2 text-xs sm:text-sm">
                  <b>TIEMPO</b> <span id="hudTime" class="font-bold">18</span>s ‚è±Ô∏è
                </span>

                <div class="flex items-center gap-2">
                  <span class="brut-chip px-3 py-2 text-xs sm:text-sm">
                    <b>CONFIANZA</b> <span id="hudTrust" class="font-bold">100</span>
                  </span>
                  <div class="w-28 sm:w-40 h-4 timer-rail">
                    <div id="trustBar" class="h-full" style="background: linear-gradient(90deg, rgba(34,197,94,.9), rgba(245,158,11,.9), rgba(251,113,133,.9)); width:100%"></div>
                  </div>
                </div>

                <button id="btnWater" class="brut-btn bg-[rgba(34,197,94,.18)] px-4 py-2 font-bold">
                  Regar üíßüå± <span id="waterStreak" class="text-xs">(racha 0)</span>
                </button>
              </div>
            </div>

            <div class="mt-3 flex items-center gap-3">
              <div class="flex-1 h-5 timer-rail">
                <div id="timerFill" class="timer-fill"></div>
              </div>
              <span id="miniStatus" class="text-xs sm:text-sm text-slate-700"></span>
            </div>
          </div>
        </div>

        <!-- Game board -->
        <div class="grid lg:grid-cols-12 gap-4">
          <!-- Left column -->
          <div class="lg:col-span-5 space-y-4">
            <div class="brut-card p-5">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-xs text-slate-700 font-semibold">PARADA ACTUAL</div>
                  <h3 class="text-2xl font-bold mt-2" id="placeTitle">‚Äî</h3>
                  <p class="text-sm text-slate-700 mt-1" id="placeTheme">‚Äî</p>
                </div>
                <div class="flex flex-col items-end gap-2">
                  <div class="text-6xl sm:text-7xl leading-none" id="placeEmoji">üèôÔ∏è</div>
                  <div class="isoIcon" aria-hidden="true" id="placeIso"></div>
                </div>
              </div>

              <div class="mt-4 brut-card p-4">
                <div class="text-xs text-slate-700 font-semibold">DATOS EDU</div>
                <ul id="eduList" class="mt-2 text-sm text-slate-700 list-disc pl-5 space-y-1"></ul>
              </div>

              <div class="mt-4 brut-card p-4">
                <div class="flex items-center justify-between gap-3">
                  <div>
                    <div class="text-xs text-slate-700 font-semibold">MICRO-RETO</div>
                    <div class="font-semibold mt-1" id="miniTitle">‚Äî</div>
                    <div class="text-sm text-slate-700 mt-1" id="miniDesc">‚Äî</div>
                  </div>
                  <button id="btnMini" class="brut-btn bg-[rgba(124,58,237,.14)] px-4 py-3 font-bold">
                    Resolver ‚ö°
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Right column -->
          <div class="lg:col-span-7 space-y-4">
            <div id="caseCard" class="brut-card p-5">
              <div class="text-xs text-slate-700 font-semibold">PISTAS DEL SIGUIENTE DESTINO</div>
              <ol id="clueList" class="mt-3 space-y-2 text-sm sm:text-base text-slate-800"></ol>

              <div class="mt-4">
                <div class="text-xs text-slate-700 font-semibold">ELIGE R√ÅPIDO</div>
                <div id="choices" class="mt-3 grid sm:grid-cols-3 gap-3"></div>
              </div>

              <div class="mt-4 brut-card p-4">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                  <div class="text-sm text-slate-700">
                    <b class="text-xs text-slate-700">REGLA</b>
                    <div class="mt-1">Si fallas, pierdes puntos/tokens y baja la confianza. Si aciertas, sube reputaci√≥n.</div>
                  </div>
                  <div class="flex gap-2">
                    <button id="btnSkip" class="brut-btn bg-[rgba(245,158,11,.18)] px-4 py-3 font-bold">
                      Pista extra (paga 2 ü™ô)
                    </button>
                    <button id="btnQuit" class="brut-btn bg-[rgba(251,113,133,.18)] px-4 py-3 font-bold">
                      Rendirse üè≥Ô∏è
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div id="feedCard" class="brut-card p-5 hidden">
              <div class="text-xs text-slate-700 font-semibold">FEEDBACK</div>
              <div id="feedText" class="mt-2 font-semibold text-lg"></div>
              <div id="feedSub" class="mt-1 text-sm text-slate-700"></div>
              <div class="mt-4 flex gap-2">
                <button id="btnNext" class="brut-btn px-5 py-3 font-bold">
                  Continuar ‚ûú
                </button>
                <button id="btnRestartMid" class="brut-btn bg-[rgba(56,189,248,.18)] px-5 py-3 font-bold">
                  Reiniciar üîÅ
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- FINAL SCREEN -->
      <section id="screenFinal" class="hidden brut-card p-5 sm:p-7">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-xs text-slate-700 font-semibold">FINAL</div>
            <h2 class="text-2xl sm:text-3xl font-bold mt-2" id="finalTitle">‚Äî</h2>
            <p class="text-slate-700 mt-2" id="finalDesc">‚Äî</p>

            <div class="mt-4 flex flex-wrap gap-2">
              <span class="brut-chip px-3 py-2 text-xs sm:text-sm">
                <b>PUNTOS</b> <span id="finalScore" class="font-bold">0</span>
              </span>
              <span class="brut-chip px-3 py-2 text-xs sm:text-sm">
                <b>TOKENS</b> <span id="finalTokens" class="font-bold">0</span> ü™ô
              </span>
              <span class="brut-chip px-3 py-2 text-xs sm:text-sm">
                <b>CONFIANZA</b> <span id="finalTrust" class="font-bold">0</span>
              </span>
            </div>
          </div>
          <div class="text-6xl sm:text-7xl">üßæüïµÔ∏è‚Äç‚ôÄÔ∏è</div>
        </div>

        <div class="mt-6 brut-card p-5">
          <div class="text-xs text-slate-700 font-semibold">IDENTIFICA AL LADR√ìN</div>
          <p class="text-sm text-slate-700 mt-2">
            Elige entre 3‚Äì5 sospechosos. Cada uno tiene 2 pistas: una real y una distractora.
          </p>

          <div id="suspects" class="mt-4 grid md:grid-cols-2 gap-3"></div>

          <div id="finalResult" class="hidden mt-4 brut-card p-4">
            <div class="font-semibold text-lg" id="finalResultTitle"></div>
            <div class="text-sm text-slate-700 mt-1" id="finalResultSub"></div>
          </div>

          <div class="mt-5 flex flex-wrap gap-2">
            <button id="btnRetry" class="brut-btn px-5 py-3 font-bold">
              Reintentar üîÅ
            </button>
            <button id="btnBackHome" class="brut-btn bg-[rgba(124,58,237,.14)] px-5 py-3 font-bold">
              Volver al inicio üè†
            </button>
          </div>
        </div>
      </section>

      <!-- GAME OVER -->
      <section id="screenOver" class="hidden brut-card p-5 sm:p-7">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-xs text-slate-700 font-semibold">GAME OVER</div>
            <h2 class="text-2xl sm:text-3xl font-bold mt-2">El ladr√≥n escap√≥ üò∂‚Äçüå´Ô∏è</h2>
            <p class="text-slate-700">
              Tu barra de confianza lleg√≥ a cero. El Mercado del Viernes qued√≥ en caos‚Ä¶ por ahora.
            </p>

            <div class="mt-4 flex flex-wrap gap-2">
              <span class="brut-chip px-3 py-2 text-xs sm:text-sm">
                <b>PUNTOS</b> <span id="overScore" class="font-bold">0</span>
              </span>
              <span class="brut-chip px-3 py-2 text-xs sm:text-sm">
                <b>TOKENS</b> <span id="overTokens" class="font-bold">0</span> ü™ô
              </span>
            </div>

            <div class="mt-6 flex gap-2">
              <button id="btnOverRetry" class="brut-btn px-5 py-3 font-bold">
                Reintentar üîÅ
              </button>
              <button id="btnOverHome" class="brut-btn bg-[rgba(56,189,248,.18)] px-5 py-3 font-bold">
                Inicio üè†
              </button>
            </div>
          </div>
          <div class="text-6xl sm:text-7xl">ü§ùüìâ</div>
        </div>
      </section>

    </main>

    <footer class="mt-8 text-xs text-slate-600">
      Hecho para portafolio ¬∑ 1 archivo ¬∑ Tailwind CDN ¬∑ Antioquia only ¬∑ Plant Nanny √ó Plant Money vibe.
    </footer>
  </div>

  <!-- ========== MOBILE DEBUG CONSOLE (iPad friendly) ========== -->
  <script>
    (function () {
      const panel = document.createElement("div");
      panel.id = "__debugPanel";
      panel.style.position = "fixed";
      panel.style.left = "12px";
      panel.style.right = "12px";
      panel.style.bottom = "12px";
      panel.style.maxHeight = "42vh";
      panel.style.overflow = "auto";
      panel.style.zIndex = "999999";
      panel.style.background = "rgba(0,0,0,.9)";
      panel.style.color = "#8bff8b";
      panel.style.font = "12px/1.35 ui-monospace, Menlo, Monaco, Consolas, monospace";
      panel.style.border = "2px solid #8bff8b";
      panel.style.borderRadius = "12px";
      panel.style.padding = "10px";
      panel.style.boxShadow = "10px 10px 0 rgba(0,0,0,.35)";
      panel.innerHTML = `
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:6px;">
          <b style="color:#fff">DEBUG</b>
          <div style="display:flex;gap:6px;align-items:center;">
            <button id="__dbgClear" style="padding:4px 8px;border:1px solid #8bff8b;border-radius:8px;background:transparent;color:#8bff8b;">Clear</button>
            <button id="__dbgHide" style="padding:4px 8px;border:1px solid #8bff8b;border-radius:8px;background:transparent;color:#8bff8b;">Hide</button>
          </div>
        </div>
        <pre id="__dbgLog" style="white-space:pre-wrap;margin:0;"></pre>
      `;
      document.body.appendChild(panel);

      const logEl = document.getElementById("__dbgLog");
      const log = (...args) => {
        const msg = args.map(a => {
          try { return typeof a === "string" ? a : JSON.stringify(a, null, 2); }
          catch { return String(a); }
        }).join(" ");
        logEl.textContent += msg + "\n";
        panel.scrollTop = panel.scrollHeight;
      };

      document.getElementById("__dbgClear").onclick = () => (logEl.textContent = "");
      document.getElementById("__dbgHide").onclick = () => (panel.style.display = "none");

      window.addEventListener("error", (e) => {
        log("‚ùå ERROR:", e.message, "|", e.filename, ":", e.lineno);
      });
      window.addEventListener("unhandledrejection", (e) => {
        log("‚ùå PROMISE:", (e.reason && e.reason.message) ? e.reason.message : e.reason);
      });

      const _log = console.log;
      console.log = (...args) => { _log.apply(console, args); log("üü© LOG:", ...args); };

      window.__dbg = { log };
      log("Debug console ready ‚úÖ");
    })();
  </script>

  <script>
    /********************
     * ISOMETRIC SVG ICONS (embedded, no external banks)
     ********************/
    const ISO = {
      cube: (accent="rgba(124,58,237,.35)") => `
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <polygon points="32,6 54,18 32,30 10,18" fill="rgba(255,255,255,.95)" stroke="var(--ink)" stroke-width="2"/>
          <polygon points="10,18 32,30 32,58 10,46" fill="${accent}" stroke="var(--ink)" stroke-width="2"/>
          <polygon points="54,18 32,30 32,58 54,46" fill="rgba(56,189,248,.25)" stroke="var(--ink)" stroke-width="2"/>
        </svg>
      `,
      plant: () => `
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <polygon points="18,28 32,36 32,58 18,50" fill="rgba(34,197,94,.28)" stroke="var(--ink)" stroke-width="2"/>
          <polygon points="46,28 32,36 32,58 46,50" fill="rgba(34,197,94,.18)" stroke="var(--ink)" stroke-width="2"/>
          <polygon points="32,16 46,28 32,40 18,28" fill="rgba(255,255,255,.95)" stroke="var(--ink)" stroke-width="2"/>
          <path d="M32 24 C26 18,22 18,18 20 C22 28,28 30,32 28" fill="rgba(34,197,94,.55)" stroke="var(--ink)" stroke-width="2"/>
          <path d="M32 24 C38 18,42 18,46 20 C42 28,36 30,32 28" fill="rgba(34,197,94,.45)" stroke="var(--ink)" stroke-width="2"/>
        </svg>
      `,
      wrench: () => `
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <polygon points="18,34 34,42 34,58 18,50" fill="rgba(245,158,11,.25)" stroke="var(--ink)" stroke-width="2"/>
          <polygon points="46,34 34,42 34,58 46,50" fill="rgba(245,158,11,.15)" stroke="var(--ink)" stroke-width="2"/>
          <polygon points="34,24 46,34 34,44 22,34" fill="rgba(255,255,255,.95)" stroke="var(--ink)" stroke-width="2"/>
          <path d="M22 18 L28 24 L24 28 L18 22 Z" fill="rgba(124,58,237,.25)" stroke="var(--ink)" stroke-width="2"/>
          <path d="M28 24 L48 44 L44 48 L24 28 Z" fill="rgba(56,189,248,.22)" stroke="var(--ink)" stroke-width="2"/>
          <path d="M48 44 L52 48 L46 54 L42 50 Z" fill="rgba(34,197,94,.20)" stroke="var(--ink)" stroke-width="2"/>
        </svg>
      `,
      ledger: () => `
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <polygon points="18,26 34,34 34,58 18,50" fill="rgba(56,189,248,.25)" stroke="var(--ink)" stroke-width="2"/>
          <polygon points="50,26 34,34 34,58 50,50" fill="rgba(124,58,237,.18)" stroke="var(--ink)" stroke-width="2"/>
          <polygon points="34,14 50,26 34,38 18,26" fill="rgba(255,255,255,.95)" stroke="var(--ink)" stroke-width="2"/>
          <line x1="23" y1="28" x2="41" y2="38" stroke="var(--ink)" stroke-width="2" opacity=".5"/>
          <line x1="23" y1="34" x2="41" y2="44" stroke="var(--ink)" stroke-width="2" opacity=".5"/>
        </svg>
      `
    };

    function mountIcons(){
      // Start screen icons
      document.getElementById("icoTrueque").innerHTML = ISO.cube("rgba(245,158,11,.25)");
      document.getElementById("icoSemillas").innerHTML = ISO.plant();
      document.getElementById("icoRepair").innerHTML = ISO.wrench();
      document.getElementById("icoRegistro").innerHTML = ISO.ledger();
    }

    /********************
     * GAME DATA (Antioquia only)
     ********************/
    const PLACES = [
      {
        id: "medellin",
        name: "Medell√≠n",
        emoji: "üèôÔ∏è",
        iso: ISO.cube("rgba(124,58,237,.28)"),
        theme: "Tema de mercado: redes de intercambio, movilidad y datos del Mercado del Viernes.",
        edu: [
          "Cultura urbana: barrios con identidad fuerte y ecosistemas creativos.",
          "Sostenibilidad: el valor crece cuando registras y mantienes confianza en el intercambio.",
          "H√°bito Plant Nanny: constancia + registro = reputaci√≥n que se acumula."
        ],
        cluesToThis: [
          "La ciudad grande donde el mercado se volvi√≥ sistema.",
          "Todo es red: movilidad, barrios, conexiones.",
          "Aqu√≠ naci√≥ la data del Mercado del Viernes."
        ],
        bigClue: "Pista extra: aqu√≠ todo es 'sistema' y 'red'."
      },
      {
        id: "envigado",
        name: "Envigado",
        emoji: "üåø",
        iso: ISO.plant(),
        theme: "Tema de mercado: viveros urbanos, semillas, h√°bitos y reputaci√≥n cuidada.",
        edu: [
          "Ambiente verde-urbano: espacios y costumbres alrededor del cuidado.",
          "Econom√≠a circular: intercambios peque√±os y frecuentes sostienen la comunidad.",
          "H√°bito: medir avances (agua, tokens, reputaci√≥n) hace visible el progreso."
        ],
        cluesToThis: [
          "Verde urbano: viveros, h√°bitos y constancia.",
          "La gente registra todo: reputaci√≥n, intercambios, disciplina.",
          "El mercado tiene vibra 'bien cuidado'."
        ],
        bigClue: "Pista extra: una parada 'verde' al borde de la ciudad."
      },
      {
        id: "sabaneta",
        name: "Sabaneta",
        emoji: "üß∫",
        iso: ISO.cube("rgba(245,158,11,.22)"),
        theme: "Tema de mercado: canastas, trueque cotidiano y micro-ofertas.",
        edu: [
          "Pueblo-ciudad: compacto y con mucha vida diaria.",
          "Sostenibilidad: el trueque reduce compras impulsivas y desperdicio.",
          "H√°bito: rachas cortas pero constantes ganan el juego."
        ],
        cluesToThis: [
          "Peque√±o pero intenso: el mercado se siente apretadito y vivo.",
          "Aqu√≠ el trueque se vuelve costumbre diaria.",
          "La canasta se llena r√°pido‚Ä¶ si eliges bien."
        ],
        bigClue: "Pista extra: el municipio 'peque√±o pero poderoso'."
      },
      {
        id: "itagui",
        name: "Itag√º√≠",
        emoji: "üè≠",
        iso: ISO.wrench(),
        theme: "Tema de mercado: repair caf√©, reutilizaci√≥n, eficiencia y oficio.",
        edu: [
          "Energ√≠a industrial: productividad y oficio como cultura cotidiana.",
          "Econom√≠a circular: reparar y reusar es valor real, no discurso.",
          "H√°bito: optimizar decisiones ahorra tokens y sube reputaci√≥n."
        ],
        cluesToThis: [
          "Sonido de industria y trabajo: aqu√≠ el mercado es producci√≥n.",
          "Reparar, reusar, optimizar: el ‚Äòrepair caf√©‚Äô pega fuerte.",
          "Los tokens se ganan con eficiencia, no con cuentos."
        ],
        bigClue: "Pista extra: aqu√≠ se arregla antes de botar."
      },
      {
        id: "bello",
        name: "Bello",
        emoji: "üé∫",
        iso: ISO.cube("rgba(56,189,248,.22)"),
        theme: "Tema de mercado: m√∫sica, feria barrial y servicios comunitarios.",
        edu: [
          "Cultura: la m√∫sica y lo popular cohesionan redes de barrio.",
          "Sostenibilidad: servicios comunitarios = resiliencia del mercado.",
          "H√°bito: la reputaci√≥n se gana ayudando, no solo comprando."
        ],
        cluesToThis: [
          "Suena a banda: donde el barrio se organiza y vibra.",
          "La feria se siente cercana y comunitaria.",
          "Los servicios se mueven por recomendaci√≥n (reputaci√≥n)."
        ],
        bigClue: "Pista extra: escucha‚Ä¶ hay m√∫sica en la pista."
      },
      {
        id: "santafe",
        name: "Santa Fe de Antioquia",
        emoji: "üèõÔ∏è",
        iso: ISO.cube("rgba(251,113,133,.18)"),
        theme: "Tema de mercado: artesan√≠as, historia viva y trueque con aire colonial.",
        edu: [
          "Arquitectura colonial: calles y fachadas que cuentan historia.",
          "Econom√≠a circular: artesan√≠as + intercambio sostienen comunidades locales.",
          "H√°bito: la paciencia y el detalle mejoran el resultado (y la confianza)."
        ],
        cluesToThis: [
          "Calles coloniales donde el sol pega sabroso y las paredes son blancas.",
          "Puentes hist√≥ricos y aire de pueblo antiguo.",
          "Aqu√≠ el trueque parece museo vivo."
        ],
        bigClue: "Pista extra: colonial + puente hist√≥rico."
      },
      {
        id: "guatape",
        name: "Guatap√©",
        emoji: "üü¶üõ∂",
        iso: ISO.ledger(),
        theme: "Tema de mercado: artesan√≠as, turismo, trueque de experiencias y oficios.",
        edu: [
          "Z√≥calos: relieves coloridos en fachadas, identidad visual √∫nica.",
          "Sostenibilidad: turismo responsable puede fortalecer econom√≠as locales.",
          "H√°bito: decisiones peque√±as (agua/registro) suman como escalones."
        ],
        cluesToThis: [
          "El pueblo pinta historias en las fachadas con relieves de colores.",
          "Hay una piedra gigante que se sube con much√≠simos escalones.",
          "El mercado vive al ritmo del embalse y los botes."
        ],
        bigClue: "Pista extra: colores en fachadas + piedra gigante."
      },
      {
        id: "rionegro",
        name: "Rionegro",
        emoji: "‚úàÔ∏è",
        iso: ISO.cube("rgba(56,189,248,.24)"),
        theme: "Tema de mercado: log√≠stica, courier, tr√°nsito de tokens y rutas.",
        edu: [
          "Oriente: cruce de caminos, comercio y movimiento constante.",
          "Econom√≠a circular: log√≠stica eficiente reduce desperdicio y costos.",
          "H√°bito: medir tiempos mejora decisiones (como tu timer)."
        ],
        cluesToThis: [
          "Pistas, maletas y llegadas: el mercado est√° cerca del aire.",
          "Cruce de caminos del Oriente: todo pasa por aqu√≠.",
          "Los courier del trueque aman este punto."
        ],
        bigClue: "Pista extra: aeropuerto + rutas."
      },
      {
        id: "marinilla",
        name: "Marinilla",
        emoji: "üé∏",
        iso: ISO.cube("rgba(124,58,237,.18)"),
        theme: "Tema de mercado: cultura, m√∫sica, artesan√≠a y comunidad.",
        edu: [
          "Cultura local: tradici√≥n y creatividad en lo cotidiano.",
          "Sostenibilidad: comprar local y trocar mantiene el valor en la regi√≥n.",
          "H√°bito: consistencia supera intensidad (racha > impulso)."
        ],
        cluesToThis: [
          "Hay cuerdas y ritmo: la cultura se oye en la plaza.",
          "El mercado valora artesan√≠a y comunidad.",
          "Aqu√≠ la reputaci√≥n corre de boca en boca."
        ],
        bigClue: "Pista extra: m√∫sica + tradici√≥n del Oriente."
      },
      {
        id: "jardin",
        name: "Jard√≠n",
        emoji: "üå∏",
        iso: ISO.plant(),
        theme: "Tema de mercado: flores, caf√©, semillas y artesan√≠as con calma.",
        edu: [
          "Paisaje: monta√±a verde y pueblo de postal.",
          "Econom√≠a circular: artesan√≠as y semillas viajan con cuidado.",
          "H√°bito: calma + constancia = resultados estables."
        ],
        cluesToThis: [
          "Balc√≥n, flores y caf√©: el mercado es postcard.",
          "Monta√±a verde, clima fresco y calma bonita.",
          "Artesan√≠as y semillas se mueven con paciencia."
        ],
        bigClue: "Pista extra: flores + caf√© + postal."
      },
      {
        id: "jerico",
        name: "Jeric√≥",
        emoji: "‚òï",
        iso: ISO.plant(),
        theme: "Tema de mercado: caf√©, reputaci√≥n, intercambio cuidadoso.",
        edu: [
          "Tradici√≥n cafetera: reputaci√≥n es capital social.",
          "Sostenibilidad: calidad + comunidad sostienen el intercambio.",
          "H√°bito: rachas (riego/registro) son la base del progreso."
        ],
        cluesToThis: [
          "Huele a caf√© y a tradici√≥n: aqu√≠ la reputaci√≥n pesa.",
          "Pueblo de laderas, miradores y calma elegante.",
          "La comunidad cuida el intercambio como ritual."
        ],
        bigClue: "Pista extra: caf√© + miradores."
      },
      {
        id: "turbo",
        name: "Turbo",
        emoji: "üèñÔ∏èüçå",
        iso: ISO.cube("rgba(245,158,11,.22)"),
        theme: "Tema de mercado: ruta de carga, banano, mar y expansi√≥n de tokens.",
        edu: [
          "Urab√°: conexi√≥n estrat√©gica, comercio y movimiento de mercanc√≠as.",
          "Econom√≠a circular: log√≠stica responsable impacta bienestar local.",
          "H√°bito: actuar a tiempo evita p√©rdidas (como el timer)."
        ],
        cluesToThis: [
          "Huele a mar y a fruta: el banano manda.",
          "La ruta del mercado mira hacia Urab√°.",
          "Aqu√≠ los tokens viajan como carga: r√°pido y lejos."
        ],
        bigClue: "Pista extra: mar + banano + Urab√°."
      }
    ];

    const MINI_CHALLENGES = [
      { title: "Validar reputaci√≥n", desc: "Un clic: confirma 3 intercambios recientes. +tokens +confianza.", reward: {tokens: 3, trust: 6, score: 35}},
      { title: "Registrar intercambio", desc: "Un clic: registra un trueque de semillas por reparaci√≥n. +tokens +score.", reward: {tokens: 4, trust: 2, score: 45}},
      { title: "Revisar historial de trueques", desc: "Un clic: detecta una anomal√≠a en el ledger. +confianza.", reward: {tokens: 2, trust: 8, score: 25}},
      { title: "Reto de confianza", desc: "Un clic: mediar un conflicto de mercado. +confianza +score.", reward: {tokens: 1, trust: 10, score: 30}},
      { title: "Auditar tokens", desc: "Un clic: confirma la ruta de 1 courier. +tokens.", reward: {tokens: 5, trust: 1, score: 20}}
    ];

    const SUSPECTS = [
      { id:"nora",  name:"Nora 'La Moderadora'",     role:"Moderator", real:"Acced√≠a al panel de reputaci√≥n sin ser vista.", fake:"Le tiene p√°nico al agua y odia las plantas." },
      { id:"tomas", name:"Tom√°s 'Courier Rel√°mpago'", role:"Courier",   real:"Estuvo en rutas que conectan intercambio y log√≠stica.", fake:"No sabe contar tokens porque solo usa efectivo." },
      { id:"lina",  name:"Lina 'Trader de Semillas'", role:"Trader",    real:"Falsific√≥ un badge en una transacci√≥n cr√≠tica.", fake:"Nunca ha visitado Antioquia." },
      { id:"bruno", name:"Bruno 'Gardener Pro'",      role:"Gardener",  real:"Conoc√≠a la firma ‚ÄúSustrato‚Äù y dej√≥ pistas en el ledger.", fake:"Al√©rgico al caf√© (imposible en Antioquia)." },
      { id:"sara",  name:"Sara 'La Reparadora'",     role:"Trader",    real:"Us√≥ un repair caf√© para camuflar el intercambio del robo.", fake:"No distingue una semilla de un tornillo." }
    ];

    /********************
     * SETTINGS + STATE
     ********************/
    const SETTINGS = {
      decisionSeconds: 18,
      roundsTotal: 6,
      scoreHit: 100,
      scoreMiss: -60,
      tokenHit: 4,
      tokenMiss: -2,
      trustHit: 10,
      trustMiss: -18,
      trustTimeout: -22,
      trustMin: 0,
      trustMax: 100,
      extraClueCost: 2
    };

    const state = {
      screen: "start",
      round: 1,
      visited: [],
      currentPlace: null,
      nextPlace: null,
      score: 0,
      tokens: 6,
      trust: 100,
      timeLeft: SETTINGS.decisionSeconds,
      timer: null,
      wateringThisRound: false,
      waterStreak: 0,
      miniChallenge: null,
      miniDoneThisRound: false,
      pendingFeedback: null,
      thiefId: null
    };

    /********************
     * HELPERS
     ********************/
    const $ = (id) => document.getElementById(id);
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const dbg = (...a) => window.__dbg?.log?.(...a);

    function shuffle(arr){
      const a = [...arr];
      for(let i=a.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function pickDifferentPlace(excludeIds){
      const options = PLACES.filter(p => !excludeIds.includes(p.id));
      return options[Math.floor(Math.random()*options.length)];
    }

    function setScreen(name){
      state.screen = name;
      $("screenStart").classList.toggle("hidden", name !== "start");
      $("screenGame").classList.toggle("hidden", name !== "game");
      $("screenFinal").classList.toggle("hidden", name !== "final");
      $("screenOver").classList.toggle("hidden", name !== "over");
    }

    function setTrust(delta){
      state.trust = clamp(state.trust + delta, SETTINGS.trustMin, SETTINGS.trustMax);
      updateHUD();
      if(state.trust <= 0) gameOver();
    }

    function addScore(delta){
      state.score = Math.max(0, state.score + delta);
      updateHUD();
    }

    function addTokens(delta){
      state.tokens = Math.max(0, state.tokens + delta);
      updateHUD();
    }

    /********************
     * UI
     ********************/
    function updateHUD(){
      $("hudScore").textContent = String(state.score);
      $("hudTokens").textContent = String(state.tokens);
      $("hudTrust").textContent = String(state.trust);
      $("hudRound").textContent = String(state.round);
      $("hudRoundsTotal").textContent = String(SETTINGS.roundsTotal);
      $("hudPlace").textContent = state.currentPlace ? state.currentPlace.name : "‚Äî";
      $("hudTime").textContent = String(state.timeLeft);

      const trustPct = (state.trust / SETTINGS.trustMax) * 100;
      $("trustBar").style.width = trustPct + "%";
      $("waterStreak").textContent = `(racha ${state.waterStreak})`;
    }

    function renderPlacePanel(){
      const p = state.currentPlace;
      $("placeTitle").textContent = p.name;
      $("placeEmoji").textContent = p.emoji;
      $("placeTheme").textContent = p.theme;
      $("placeIso").innerHTML = p.iso;

      const edu = $("eduList");
      edu.innerHTML = "";
      p.edu.forEach(item=>{
        const li = document.createElement("li");
        li.textContent = item;
        edu.appendChild(li);
      });
    }

    function renderMiniChallenge(){
      state.miniChallenge = shuffle(MINI_CHALLENGES)[0];
      state.miniDoneThisRound = false;

      $("miniTitle").textContent = state.miniChallenge.title;
      $("miniDesc").textContent = state.miniChallenge.desc;
      $("miniStatus").textContent = "";
      $("btnMini").disabled = false;
      $("btnMini").classList.remove("opacity-50");
    }

    function renderCluesAndChoices(){
      const next = state.nextPlace;

      // 3 clues
      const base = shuffle([...next.cluesToThis]).slice(0,3);
      const clueList = $("clueList");
      clueList.innerHTML = "";
      base.forEach((c, idx)=>{
        const li = document.createElement("li");
        li.className = "brut-card p-3 sm:p-4";
        li.innerHTML = `
          <div class="text-[11px] text-slate-600 font-semibold">PISTA ${idx+1}</div>
          <div class="mt-1">${c}</div>
        `;
        clueList.appendChild(li);
      });

      // 3 choices: correct + 2 distractors
      const exclude = new Set([state.currentPlace.id, next.id]);
      const distract1 = pickDifferentPlace([...exclude]);
      exclude.add(distract1.id);
      const distract2 = pickDifferentPlace([...exclude]);

      const options = shuffle([next, distract1, distract2]);
      const choices = $("choices");
      choices.innerHTML = "";

      options.forEach(p=>{
        const btn = document.createElement("button");
        btn.className = "brut-btn p-4 text-left hover:bg-[rgba(56,189,248,.10)]";
        btn.innerHTML = `
          <div class="flex items-start justify-between gap-2">
            <div class="min-w-0">
              <div class="text-[11px] text-slate-600 font-semibold">DESTINO</div>
              <div class="text-base sm:text-lg font-bold mt-1">${p.name}</div>
              <div class="text-xs text-slate-600 mt-1 line-clamp-2">${p.theme}</div>
              <div class="mt-2 flex items-center gap-2">
                <span class="isoIcon" style="width:44px;height:44px;border-radius:12px;">${p.iso}</span>
                <span class="text-3xl">${p.emoji}</span>
              </div>
            </div>
          </div>
        `;
        btn.addEventListener("click", ()=> chooseDestination(p.id), { passive: true });
        choices.appendChild(btn);
      });

      $("btnSkip").disabled = false;
      $("btnSkip").classList.remove("opacity-50");
      $("feedCard").classList.add("hidden");
      $("caseCard").classList.remove("hidden");
      $("caseCard").classList.remove("pulse-ok","pulse-bad");
    }

    function showFeedback({ok, title, sub}){
      $("feedText").textContent = title;
      $("feedSub").textContent = sub;
      $("caseCard").classList.add("hidden");
      $("feedCard").classList.remove("hidden");

      const target = $("feedCard");
      target.classList.remove("pulse-ok","pulse-bad");
      void target.offsetWidth;
      target.classList.add(ok ? "pulse-ok" : "pulse-bad");
    }

    /********************
     * TIMER
     ********************/
    function stopTimer(){
      if(state.timer) clearInterval(state.timer);
      state.timer = null;
      state.timeLeft = SETTINGS.decisionSeconds;
      $("timerFill").style.width = "100%";
      updateHUD();
    }

    function startTimer(){
      stopTimer();
      state.timeLeft = SETTINGS.decisionSeconds;
      updateHUD();

      state.timer = setInterval(()=>{
        state.timeLeft -= 1;
        const pct = (state.timeLeft / SETTINGS.decisionSeconds) * 100;
        $("timerFill").style.width = clamp(pct,0,100) + "%";
        updateHUD();

        if(state.timeLeft <= 0){
          clearInterval(state.timer);
          state.timer = null;
          onTimeout();
        }
      }, 1000);
    }

    function timeBonus(){
      const ratio = state.timeLeft / SETTINGS.decisionSeconds;
      return Math.round(80 * clamp(ratio, 0, 1));
    }

    /********************
     * GAME FLOW
     ********************/
    function newGame(){
      dbg("newGame() ‚úÖ");

      state.round = 1;
      state.visited = [];
      state.score = 0;
      state.tokens = 6;
      state.trust = 100;
      state.wateringThisRound = false;
      state.waterStreak = 0;
      state.miniChallenge = null;
      state.miniDoneThisRound = false;
      state.pendingFeedback = null;
      state.thiefId = shuffle(SUSPECTS)[0].id;

      stopTimer();

      const start = PLACES.find(p => p.id === "medellin") || PLACES[0];
      state.currentPlace = start;
      state.visited.push(start.id);

      state.nextPlace = pickDifferentPlace([state.currentPlace.id]);

      setScreen("game");
      updateHUD();
      renderRound();
    }

    function renderRound(){
      renderPlacePanel();
      renderMiniChallenge();
      renderCluesAndChoices();

      state.wateringThisRound = false;
      $("btnWater").disabled = false;
      $("btnWater").classList.remove("opacity-50");

      $("miniStatus").textContent = "Tienes 18s. Decide con calma y precisi√≥n.";
      startTimer();
    }

    function chooseDestination(placeId){
      if(state.screen !== "game") return;

      stopTimer();

      const ok = (placeId === state.nextPlace.id);
      const bonus = timeBonus();

      // lock buttons
      Array.from($("choices").querySelectorAll("button")).forEach(b=> b.disabled = true);
      $("btnSkip").disabled = true;
      $("btnSkip").classList.add("opacity-50");

      if(ok){
        addScore(SETTINGS.scoreHit + bonus);
        addTokens(SETTINGS.tokenHit);
        setTrust(SETTINGS.trustHit);
        if(state.miniDoneThisRound) setTrust(2);

        state.pendingFeedback = {
          ok: true,
          title: `Acierto ‚úÖ ‚Äî ${state.nextPlace.name} era la ruta.`,
          sub: `+${SETTINGS.scoreHit} pts +${bonus} bonus | +${SETTINGS.tokenHit} ü™ô | +${SETTINGS.trustHit} confianza`
        };
      } else {
        addScore(SETTINGS.scoreMiss);
        addTokens(SETTINGS.tokenMiss);
        setTrust(SETTINGS.trustMiss);

        state.pendingFeedback = {
          ok: false,
          title: `Fallaste ‚ùå ‚Äî el rastro iba hacia ${state.nextPlace.name}.`,
          sub: `${SETTINGS.scoreMiss} pts | ${SETTINGS.tokenMiss} ü™ô | ${SETTINGS.trustMiss} confianza`
        };
      }

      const chosen = PLACES.find(p=>p.id===placeId);
      state.currentPlace = chosen || state.nextPlace;

      if(!state.visited.includes(state.currentPlace.id)){
        state.visited.push(state.currentPlace.id);
      }

      state.nextPlace = pickDifferentPlace([state.currentPlace.id]);

      showFeedback(state.pendingFeedback);
      $("miniStatus").textContent = ok ? "Rastro confirmado. Sigue." : "Perdiste tiempo. Ajusta el enfoque.";
    }

    function onTimeout(){
      addScore(-30);
      addTokens(-1);
      setTrust(SETTINGS.trustTimeout);

      state.pendingFeedback = {
        ok: false,
        title: "Tiempo agotado ‚è≥ ‚Äî el ladr√≥n gan√≥ ventaja.",
        sub: `-30 pts | -1 ü™ô | ${SETTINGS.trustTimeout} confianza`
      };

      state.currentPlace = state.nextPlace;
      if(!state.visited.includes(state.currentPlace.id)){
        state.visited.push(state.currentPlace.id);
      }
      state.nextPlace = pickDifferentPlace([state.currentPlace.id]);

      showFeedback(state.pendingFeedback);
      $("miniStatus").textContent = "Respira. Decide antes del tick final.";
    }

    function nextStep(){
      if(state.screen !== "game") return;

      state.round += 1;
      if(state.round > SETTINGS.roundsTotal){
        goFinal();
        return;
      }

      renderRound();
      updateHUD();
    }

    function gameOver(){
      stopTimer();
      setScreen("over");
      $("overScore").textContent = String(state.score);
      $("overTokens").textContent = String(state.tokens);
    }

    function goFinal(){
      stopTimer();
      setScreen("final");

      $("finalScore").textContent = String(state.score);
      $("finalTokens").textContent = String(state.tokens);
      $("finalTrust").textContent = String(state.trust);

      const visitedCount = state.visited.length;
      const good = state.trust >= 35;

      $("finalTitle").textContent = good
        ? "Llegaste al cierre del caso. El Mercado respira‚Ä¶"
        : "Llegaste por poco. El Mercado est√° fr√°gil‚Ä¶";

      $("finalDesc").textContent =
        `Visitaste ${visitedCount} municipios. Ahora viene lo duro: identificar al ladr√≥n entre sospechosos.`;

      let suspects = shuffle(SUSPECTS).slice(0, 4);
      if(!suspects.some(s=>s.id===state.thiefId)){
        suspects[0] = SUSPECTS.find(s=>s.id===state.thiefId) || suspects[0];
      }

      const wrap = $("suspects");
      wrap.innerHTML = "";
      $("finalResult").classList.add("hidden");

      suspects.forEach(s=>{
        const card = document.createElement("button");
        card.className = "brut-btn p-4 text-left hover:bg-[rgba(124,58,237,.10)]";

        const order = shuffle([s.real, s.fake]);

        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-[11px] text-slate-600 font-semibold">SOSPECHOSO</div>
              <div class="text-lg font-bold mt-1">${s.name}</div>
              <div class="text-xs text-slate-600 mt-1">Rol: ${s.role}</div>
            </div>
            <div class="text-3xl">üï¥Ô∏è</div>
          </div>
          <div class="mt-3 text-sm text-slate-700">
            <div class="brut-card p-3">
              <div class="text-[11px] text-slate-600 font-semibold">PISTA A</div>
              <div class="mt-1">${order[0]}</div>
            </div>
            <div class="brut-card p-3 mt-2">
              <div class="text-[11px] text-slate-600 font-semibold">PISTA B</div>
              <div class="mt-1">${order[1]}</div>
            </div>
          </div>
        `;
        card.addEventListener("click", ()=> pickSuspect(s.id), { passive: true });
        wrap.appendChild(card);
      });
    }

    function pickSuspect(id){
      const ok = (id === state.thiefId);
      const box = $("finalResult");
      box.classList.remove("hidden");
      box.classList.remove("pulse-ok","pulse-bad");
      void box.offsetWidth;
      box.classList.add(ok ? "pulse-ok" : "pulse-bad");

      if(ok){
        $("finalResultTitle").textContent = "¬°Captura confirmada! ü™ôüå±";
        $("finalResultSub").textContent =
          "Recuperaste tokens, restauraste reputaci√≥n y dejaste el Mercado del Viernes m√°s fuerte. Final bueno (por ahora).";
        addScore(120);
        addTokens(6);
        setTrust(10);
        $("finalScore").textContent = String(state.score);
        $("finalTokens").textContent = String(state.tokens);
        $("finalTrust").textContent = String(state.trust);
      } else {
        $("finalResultTitle").textContent = "Era un se√±uelo‚Ä¶ üò∂‚Äçüå´Ô∏è";
        $("finalResultSub").textContent =
          "El Ladr√≥n del Sustrato se mezcl√≥ en la multitud. Final malo, con bot√≥n de reintento.";
        setTrust(-15);
        $("finalTrust").textContent = String(state.trust);
      }
    }

    /********************
     * ACTIONS
     ********************/
    function water(){
      if(state.screen !== "game") return;
      if(state.wateringThisRound) return;

      state.wateringThisRound = true;
      state.waterStreak += 1;

      const streakBonus = (state.waterStreak >= 2) ? 10 : 5;
      addScore(10);
      setTrust(streakBonus);

      $("miniStatus").textContent = state.waterStreak >= 2
        ? `Racha de riego üî• +${streakBonus} confianza`
        : `Riego aplicado üíß +${streakBonus} confianza`;

      $("btnWater").disabled = true;
      $("btnWater").classList.add("opacity-50");
      updateHUD();
    }

    function mini(){
      if(state.screen !== "game") return;
      if(state.miniDoneThisRound) return;

      state.miniDoneThisRound = true;

      const r = state.miniChallenge.reward;
      addTokens(r.tokens);
      addScore(r.score);
      setTrust(r.trust);

      $("miniStatus").textContent = `Mini-reto completado ‚ö° +${r.tokens}ü™ô +${r.score}pts +${r.trust} confianza`;
      $("btnMini").disabled = true;
      $("btnMini").classList.add("opacity-50");
    }

    function extraClue(){
      if(state.screen !== "game") return;

      if(state.tokens < SETTINGS.extraClueCost){
        $("miniStatus").textContent = "No tienes tokens suficientes para comprar pista extra ü™ô";
        $("caseCard").classList.remove("pulse-ok","pulse-bad");
        void $("caseCard").offsetWidth;
        $("caseCard").classList.add("pulse-bad");
        return;
      }

      addTokens(-SETTINGS.extraClueCost);

      const extra = document.createElement("li");
      extra.className = "brut-card p-3 sm:p-4";
      extra.innerHTML = `
        <div class="text-[11px] text-slate-600 font-semibold">PISTA EXTRA</div>
        <div class="mt-1">${state.nextPlace.bigClue}</div>
      `;
      $("clueList").appendChild(extra);

      $("miniStatus").textContent = `Pista extra comprada (-${SETTINGS.extraClueCost}ü™ô). √ösala bien.`;
      $("btnSkip").disabled = true;
      $("btnSkip").classList.add("opacity-50");

      $("caseCard").classList.remove("pulse-ok","pulse-bad");
      void $("caseCard").offsetWidth;
      $("caseCard").classList.add("pulse-ok");
    }

    /********************
     * EVENTS + INIT
     ********************/
    function bind(){
      // icons
      mountIcons();

      // start screen
      $("btnStart").addEventListener("click", newGame, { passive: true });
      $("btnHow").addEventListener("click", ()=> $("howPanel").classList.toggle("hidden"), { passive: true });

      // game
      $("btnWater").addEventListener("click", water, { passive: true });
      $("btnMini").addEventListener("click", mini, { passive: true });
      $("btnNext").addEventListener("click", nextStep, { passive: true });
      $("btnRestartMid").addEventListener("click", newGame, { passive: true });
      $("btnSkip").addEventListener("click", extraClue, { passive: true });

      $("btnQuit").addEventListener("click", ()=>{
        stopTimer();
        setTrust(-999);
      });

      // final
      $("btnRetry").addEventListener("click", newGame, { passive: true });
      $("btnBackHome").addEventListener("click", ()=>{
        stopTimer();
        setScreen("start");
      }, { passive: true });

      // over
      $("btnOverRetry").addEventListener("click", newGame, { passive: true });
      $("btnOverHome").addEventListener("click", ()=>{
        stopTimer();
        setScreen("start");
      }, { passive: true });

      setScreen("start");
      updateHUD();
      dbg("init ‚úÖ listeners OK");
    }

    document.addEventListener("DOMContentLoaded", bind);
  </script>
</body>
</html>